<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vallejo Paint Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="data.js"></script>
    <style>
        .paint-group {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .paint-swatch {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.5rem;
            background: white;
        }
        .color-block {
            aspect-ratio: 2.975 / 1;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        function App() {
            const [paints, setPaints] = useState(() => {
                const saved = localStorage.getItem('vallejo-paint-data');
                if (saved) {
                    const savedData = JSON.parse(saved);
                    const ownedSet = new Set(savedData.owned || []);
                    const toBuySet = new Set(savedData.toBuy || []);
                    
                    return window.paintData.map(paint => ({
                        ...paint,
                        owned: ownedSet.has(paint.id),
                        toBuy: toBuySet.has(paint.id)
                    }));
                }
                return window.paintData.map(paint => ({ ...paint, owned: false, toBuy: false }));
            });

            const [syncStatus, setSyncStatus] = useState('');
            const [showSyncModal, setShowSyncModal] = useState(false);
            const [showLoadConfirm, setShowLoadConfirm] = useState(false);
            const [pendingHashData, setPendingHashData] = useState('');
            const [manualCode, setManualCode] = useState('');

            // Check for encoded data in URL hash on mount
            useEffect(() => {
                const hash = window.location.hash.slice(1);
                if (hash && hash.length > 20) {
                    setPendingHashData(hash);
                    setShowLoadConfirm(true);
                }
            }, []);

            const [searchTerm, setSearchTerm] = useState('');
            const [showTriads, setShowTriads] = useState(false);
            const [filters, setFilters] = useState({
                owned: false,
                notOwned: false,
                toBuy: false
            });

            const paintTypes = [
                "Regular", "Metallic", "Ink", "Wash", "Fluo", 
                "Special FX", "Auxiliary", "Xpress", "Xpress Intense"
            ];

            // Save to localStorage whenever paints change
            useEffect(() => {
                const dataToSave = {
                    owned: paints.filter(p => p.owned).map(p => p.id),
                    toBuy: paints.filter(p => p.toBuy).map(p => p.id)
                };
                localStorage.setItem('vallejo-paint-data', JSON.stringify(dataToSave));
            }, [paints]);

            const handleOwned = (id, checked) => {
                setPaints(prev => prev.map(p => 
                    p.id === id ? { ...p, owned: checked, toBuy: checked ? false : p.toBuy } : p
                ));
            };

            const handleToBuy = (id, checked) => {
                setPaints(prev => prev.map(p => 
                    p.id === id ? { ...p, toBuy: checked } : p
                ));
            };

            const handleOwnedFilter = (checked) => {
                setFilters(prev => ({
                    ...prev,
                    owned: checked,
                    notOwned: checked ? false : prev.notOwned
                }));
            };

            const handleNotOwnedFilter = (checked) => {
                setFilters(prev => ({
                    ...prev,
                    notOwned: checked,
                    owned: checked ? false : prev.owned
                }));
            };

            const exportData = () => {
                // Export as separate arrays - most compact format
                const dataToExport = {
                    owned: paints.filter(p => p.owned).map(p => p.id),
                    toBuy: paints.filter(p => p.toBuy).map(p => p.id)
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'vallejo-paints.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            
                            // Validate format
                            if (!imported.owned || !Array.isArray(imported.owned)) {
                                throw new Error('Invalid format: expected {owned: [...], toBuy: [...]}');
                            }
                            
                            const ownedSet = new Set(imported.owned);
                            const toBuySet = new Set(imported.toBuy || []);
                            
                            // Merge imported data with current paint definitions
                            setPaints(prev => prev.map(paint => ({
                                ...paint,
                                owned: ownedSet.has(paint.id),
                                toBuy: toBuySet.has(paint.id)
                            })));
                            
                            alert('Data imported successfully!');
                        } catch (error) {
                            alert('Error importing data: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const resetData = () => {
                if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                    setPaints(prev => prev.map(p => ({ ...p, owned: false, toBuy: false })));
                    localStorage.removeItem('vallejo-paint-data');
                }
            };

            const shareToCloud = async () => {
                setSyncStatus('Creating share link...');
                try {
                    const dataToShare = {
                        owned: paints.filter(p => p.owned).map(p => p.idx),
                        toBuy: paints.filter(p => p.toBuy).map(p => p.idx)
                    };

                    // Encode the data directly in the URL hash
                    const jsonString = JSON.stringify(dataToShare);
                    const encoded = btoa(jsonString);
                    const shareUrl = `${window.location.origin}${window.location.pathname}#${encoded}`;
                    
                    // Copy to clipboard
                    await navigator.clipboard.writeText(shareUrl);
                    
                    setSyncStatus(`✓ Link copied to clipboard!`);
                    setTimeout(() => setSyncStatus(''), 5000);
                } catch (error) {
                    console.error('Share error:', error);
                    setSyncStatus(`✗ Error: ${error.message}`);
                    setTimeout(() => setSyncStatus(''), 5000);
                }
            };

            const loadFromHash = (encodedData) => {
                setSyncStatus('Loading from URL...');
                try {
                    // Decode the base64 data from URL hash
                    const jsonString = atob(encodedData);
                    const imported = JSON.parse(jsonString);

                    // Create lookup sets using idx
                    const ownedIdxSet = new Set(imported.owned || []);
                    const toBuyIdxSet = new Set(imported.toBuy || []);
                    
                    setPaints(prev => prev.map(paint => ({
                        ...paint,
                        owned: ownedIdxSet.has(paint.idx),
                        toBuy: toBuyIdxSet.has(paint.idx)
                    })));

                    setSyncStatus('✓ Loaded successfully!');
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch (error) {
                    console.error('Load error:', error);
                    setSyncStatus(`✗ Error loading data: ${error.message}`);
                    setTimeout(() => setSyncStatus(''), 5000);
                }
            };

            const handleManualLoad = () => {
                if (manualCode.trim().length > 0) {
                    setPendingHashData(manualCode.trim());
                    setShowSyncModal(false);
                    setShowLoadConfirm(true);
                    setManualCode('');
                } else {
                    setSyncStatus('✗ Please enter a code');
                    setTimeout(() => setSyncStatus(''), 3000);
                }
            };

            const confirmLoad = () => {
                loadFromHash(pendingHashData);
                setShowLoadConfirm(false);
                setPendingHashData('');
            };

            const cancelLoad = () => {
                setShowLoadConfirm(false);
                setPendingHashData('');
                // Clear hash from URL if it was from URL
                window.history.replaceState(null, '', window.location.pathname);
            };

            // Handle Escape key for modals
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        if (showSyncModal) {
                            setShowSyncModal(false);
                            setManualCode('');
                        }
                        if (showLoadConfirm) {
                            cancelLoad();
                        }
                    }
                };
                
                window.addEventListener('keydown', handleEscape);
                return () => window.removeEventListener('keydown', handleEscape);
            }, [showSyncModal, showLoadConfirm]);

            const filteredPaints = useMemo(() => {
                let filtered = [...paints];

                // Apply ownership filters
                if (filters.owned) {
                    filtered = filtered.filter(p => p.owned);
                }
                if (filters.notOwned) {
                    filtered = filtered.filter(p => !p.owned);
                }
                if (filters.toBuy) {
                    filtered = filtered.filter(p => p.toBuy);
                }

                // Apply search
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(term) || 
                        p.id.includes(term)
                    );
                }

                return filtered;
            }, [paints, filters, searchTerm]);

            const groupedPaints = useMemo(() => {
                if (searchTerm) {
                    // Flatten when searching
                    return { "Search Results": filteredPaints };
                }

                const grouped = {};
                paintTypes.forEach(type => {
                    const typePaints = filteredPaints.filter(p => p.type === type);
                    if (typePaints.length > 0) {
                        grouped[type] = typePaints;
                    }
                });
                return grouped;
            }, [filteredPaints, searchTerm]);

            const stats = useMemo(() => ({
                owned: paints.filter(p => p.owned).length,
                toBuy: paints.filter(p => p.toBuy).length,
                total: paints.length
            }), [paints]);

            const triadStats = useMemo(() => {
                let complete = 0;
                let missing1 = 0;
                let missing2 = 0;

                window.triads.forEach(triad => {
                    const owned = triad.filter(id => paints.find(p => p.id === id)?.owned).length;
                    if (owned === 3) complete++;
                    else if (owned === 2) missing1++;
                    else if (owned === 1) missing2++;
                });

                return { complete, missing1, missing2 };
            }, [paints]);

            return (
                <div className="max-w-7xl mx-auto p-4">
                    {/* Header with title and counters */}
                    <div className="mb-4 flex justify-between items-center">
                        <h1 className="text-3xl font-bold">Vallejo Paint Tracker</h1>
                        <div className="flex gap-4">
                            <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                Owned: {stats.owned}/{stats.total}
                            </span>
                            <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full">
                                Wishlist: {stats.toBuy}
                            </span>
                        </div>
                    </div>

                    {/* Search, filters and buttons row */}
                    <div className="mb-6 flex flex-col sm:flex-row gap-4 items-center">
                        <input
                            type="text"
                            placeholder="Search by name or ID..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-1 p-2 border rounded"
                        />
                        
                        {/* Filter checkboxes with group border */}
                        <div className="border border-gray-300 rounded-lg px-4 py-2 bg-gray-50">
                            <div className="flex gap-4 text-base">
                                <label className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={filters.owned}
                                        onChange={(e) => handleOwnedFilter(e.target.checked)}
                                        className="mr-2"
                                    />
                                    Owned
                                </label>
                                <label className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={filters.notOwned}
                                        onChange={(e) => handleNotOwnedFilter(e.target.checked)}
                                        className="mr-2"
                                    />
                                    Missing
                                </label>
                                <label className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={filters.toBuy}
                                        onChange={(e) => setFilters(prev => ({ ...prev, toBuy: e.target.checked }))}
                                        className="mr-2"
                                    />
                                    Wishlist
                                </label>
                            </div>
                        </div>

                        <div className="flex gap-2 flex-wrap">
                            <button
                                onClick={() => setShowTriads(!showTriads)}
                                className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 whitespace-nowrap"
                            >
                                BSL
                            </button>
                            <button 
                                onClick={shareToCloud}
                                className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 whitespace-nowrap"
                                title="Create a shareable link for other devices"
                            >
                                Share
                            </button>
                            <button 
                                onClick={() => setShowSyncModal(true)}
                                className="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 whitespace-nowrap"
                                title="Load collection from a code"
                            >
                                Load
                            </button>
                            <button 
                                onClick={exportData}
                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 whitespace-nowrap"
                            >
                                Export
                            </button>
                            <label className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer whitespace-nowrap">
                                Import
                                <input 
                                    type="file" 
                                    accept=".json"
                                    onChange={importData}
                                    className="hidden"
                                />
                            </label>
                            <button 
                                onClick={resetData}
                                className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 whitespace-nowrap"
                            >
                                Reset
                            </button>
                        </div>
                    </div>

                    {/* Sync status message */}
                    {syncStatus && (
                        <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm">
                            {syncStatus}
                        </div>
                    )}

                    {/* Manual code entry modal */}
                    {showSyncModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-lg font-bold mb-4">Load from Code</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Paste the code from the end of your shared URL:
                                </p>
                                <input
                                    type="text"
                                    value={manualCode}
                                    onChange={(e) => setManualCode(e.target.value)}
                                    placeholder="Paste code here..."
                                    className="w-full p-2 border rounded mb-4 font-mono text-xs"
                                />
                                <div className="flex gap-2 justify-end">
                                    <button
                                        onClick={() => {
                                            setShowSyncModal(false);
                                            setManualCode('');
                                        }}
                                        className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleManualLoad}
                                        className="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700"
                                    >
                                        Load
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Load confirmation modal */}
                    {showLoadConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-lg font-bold mb-4">⚠️ Overwrite Collection?</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Loading this shared collection will replace your current paint data. 
                                    Consider exporting your current collection first if you want to keep it.
                                </p>
                                <div className="flex gap-2 justify-end">
                                    <button
                                        onClick={cancelLoad}
                                        className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmLoad}
                                        className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                    >
                                        Replace My Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTriads && (
                        <div className="mb-6 paint-group">
                            <h2 className="text-xl font-bold mb-4">
                                Game Color Triads (BSL System)
                                <span className="ml-4 text-sm font-normal">
                                    <span className="text-green-600">Complete: {triadStats.complete}</span>
                                    <span className="ml-4 text-yellow-600">Missing 1: {triadStats.missing1}</span>
                                    <span className="ml-4 text-orange-600">Missing 2: {triadStats.missing2}</span>
                                </span>
                            </h2>
                            <div className="mb-2 grid grid-cols-9 gap-2 text-center text-xs font-semibold">
                                <div>H</div><div>B</div><div>S</div>
                                <div>H</div><div>B</div><div>S</div>
                                <div>H</div><div>B</div><div>S</div>
                            </div>
                            <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-9 gap-2">
                                {window.triads.map((triad, idx) => (
                                    triad.map((paintId) => {
                                        const paint = paints.find(p => p.id === paintId);
                                        if (!paint) return <div key={`${idx}-${paintId}`} className="paint-swatch">Missing</div>;
                                        return (
                                            <div key={`${idx}-${paintId}`} className="paint-swatch">
                                                <div 
                                                    className="color-block mb-1"
                                                    style={{ backgroundColor: paint.color }}
                                                />
                                                <div className="text-xs">{paint.id}</div>
                                                <div className="text-xs truncate">{paint.name}</div>
                                                <div className="text-xs text-gray-500 truncate">
                                                    {paint.citadel || "N/A"}
                                                </div>
                                                <div className="flex gap-2 mt-1">
                                                    <label className="text-xs flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            checked={paint.owned}
                                                            onChange={(e) => handleOwned(paint.id, e.target.checked)}
                                                            className="mr-1"
                                                        />
                                                        Own
                                                    </label>
                                                    <label className="text-xs flex items-center">
                                                        <input
                                                            type="checkbox"
                                                            checked={paint.toBuy}
                                                            disabled={paint.owned}
                                                            onChange={(e) => handleToBuy(paint.id, e.target.checked)}
                                                            className="mr-1"
                                                        />
                                                        Buy
                                                    </label>
                                                </div>
                                            </div>
                                        );
                                    })
                                ))}
                            </div>
                        </div>
                    )}

                    <div>
                        {Object.entries(groupedPaints).map(([type, typePaints]) => (
                            <div key={type} className="paint-group">
                                <h2 className="text-xl font-bold mb-4">
                                    {type === "Regular" ? "Game Color" : 
                                     type === "Metallic" ? "Game Color Metallic" :
                                     type === "Ink" ? "Game Color Ink" :
                                     type === "Wash" ? "Game Color Wash" :
                                     type === "Fluo" ? "Game Color Fluo" :
                                     type === "Special FX" ? "Game Color Special FX" :
                                     type === "Auxiliary" ? "Auxiliary Products" :
                                     type === "Xpress" ? "Xpress Color" :
                                     type === "Xpress Intense" ? "Xpress Color Intense" :
                                     type}
                                </h2>
                                <div className="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-6 lg:grid-cols-9 gap-2">
                                    {typePaints.map(paint => (
                                        <div key={paint.id} className="paint-swatch">
                                            <div 
                                                className="color-block mb-1"
                                                style={{ backgroundColor: paint.color }}
                                            />
                                            <div className="text-xs font-semibold">{paint.id}</div>
                                            <div className="text-xs truncate">{paint.name}</div>
                                            <div className="text-xs text-gray-500 truncate">
                                                {paint.citadel || "N/A"}
                                            </div>
                                            <div className="flex gap-2 mt-1">
                                                <label className="text-xs flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={paint.owned}
                                                        onChange={(e) => handleOwned(paint.id, e.target.checked)}
                                                        className="mr-1"
                                                    />
                                                    Own
                                                </label>
                                                <label className="text-xs flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={paint.toBuy}
                                                        disabled={paint.owned}
                                                        onChange={(e) => handleToBuy(paint.id, e.target.checked)}
                                                        className="mr-1"
                                                    />
                                                    Buy
                                                </label>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
